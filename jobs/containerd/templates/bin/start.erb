#!/usr/bin/env bash
set -eux

# shellcheck disable=SC1091
source /var/vcap/jobs/containerd/bin/envs

log() {
  local msg
  local time

  msg=$1
  time=$(date +"%e/%m/%Y - %T")

  echo "$time $msg" >> "${CONTAINERD_LOG_DIR}/containerd_ctl.log"
}

export PATH="${PATH}:/var/vcap/packages/containerd/bin"
export PATH="${PATH}:/var/vcap/packages/runc/bin"
export PATH="${PATH}:/var/vcap/packages/guardian/bin"
export PATH="${PATH}:/var/vcap/packages/garden-idmapper/bin"
export TMPDIR="${CONTAINERD_TMP_DIR}"

export MAXIMUS=$(/var/vcap/packages/garden-idmapper/bin/maximus)

exec 1>> "${CONTAINERD_LOG_DIR}/containerd.stdout.log"
exec 2>> "${CONTAINERD_LOG_DIR}/containerd.stderr.log"

log "running greenskeeper"
greenskeeper_cmd="/var/vcap/packages/greenskeeper/bin/greenskeeper --containerd"
<% if p("garden.experimental_rootless_mode") %>
  greenskeeper_cmd="$greenskeeper_cmd --rootless"
<% end %>
$greenskeeper_cmd
log "running greenskeeper: done"

<% if p("garden.experimental_rootless_mode") %>
cp "$CONTAINERD_CONFIG_DIR/containerd.toml" "$CONTAINERD_ROOTLESS_CONFIG_DIR/containerd.toml"
chown "$MAXIMUS:$MAXIMUS" "$CONTAINERD_ROOTLESS_CONFIG_DIR/containerd.toml"
chown vcap:4294967294 /var/vcap/data/garden
<% end %>


echo $$ > "$CONTAINERD_PID_FILEPATH"

exec 1>> "${CONTAINERD_LOG_DIR}/containerd.stdout.log"
exec 2>> "${CONTAINERD_LOG_DIR}/containerd.stderr.log"


log "moving init"
rm -f "$INIT_BIN_DIR"/init
cp /var/vcap/packages/guardian/bin/init "$INIT_BIN_DIR"/init

log "starting containerd"
<% if p("garden.experimental_rootless_mode") %>
exec execas --uid "$MAXIMUS" --gid "$MAXIMUS" containerd -c "$CONTAINERD_ROOTLESS_CONFIG_DIR/containerd.toml"
<% else %>
exec containerd -c "$CONTAINERD_CONFIG_DIR/containerd.toml"
<% end %>
